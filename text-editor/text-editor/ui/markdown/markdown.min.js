/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.4.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.ui.Markdown=function(e,t){function v(e){return b(e.replace(/\s+/g," "))}function k(e){return m(v(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function _(e){return m(v(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}var n=TE.ui.HTML||TE.ui,r=n(e,{extra:0,auto_p:0,auto_close:{"`":"`","*":"*",_:"_","~":"~"},tools:"b i s | a img | note abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{note:["Footnote","⌘+↓"]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},note:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:["~~"],h1:["=","#"],h2:["-","##"],h3:["###"],h4:["####"],h5:["#####"],h6:["######"],blockquote:[">"],code:["`","~"],ul:["-","+","*"],ol:["%1."],hr:["---","+++","***"]}}),l=r.ui,i="	",a=TE.is,s=a.o,o=function(e){return!a.x(e)},c=a.s,f=r._,u=f.edge,p=f.x,h=f.extend,d=f.format,$=f.i,g=f.pattern,m=f.replace,b=f.trim;r.update(t,0),r.type="Markdown";var y=r.config,w=y.extra,x=y.formats,q=y.languages,T=y.states,O=y.tab,L=q.placeholders,S="( +["+p(x.ul).join("")+"] )",I=0;return w||(y["advance_pre,code"]=0),r.mark=function(e,t,n,l){s(e)||(e=[e]),o(n)||(n=" "),o(l)||(l="");var i=r.h,a=r[0]().$(),c=e[0]+l,f=l+(o(e[1])?e[1]:e[0]),u=a.value,h=p(c),d=p(f),$=g("^"+h+"([\\s\\S]*?)"+d+"$"),m=g(h+"$"),b=g("^"+d),v=a.before,k=a.after;return u?n=!1:r.insert(L[""]),r.toggle(t?!$.test(u):!m.test(v)&&!b.test(k),[function(e){e.unwrap(c,f,1).tidy(/<[^\/<>]+?>$/.test(v)?"":n,/^<\/[^<>]+?>/.test(k)?"":n).wrap(c,f,t)},function(e){e.unwrap(c,f,t)}])[i]()},h(l.tools,{b:{click:function(e,t){return t.i().mark(x.b[0]),!1}},i:{click:function(e,t){return t.i().mark(x.i[0]),!1}},u:0,s:w?{click:function(e,t){return t.i().mark(x.s[0]),!1}}:0,a:{click:function(e,t){var p,h,d,$,g,m,v,n=t.$(),r=n.before,i=n.value,a=n.after,s=t.get(),o=/^ {0,3}\[[^\^]+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",c=s.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],f=q.modals.a,u=f.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(i))return t.tidy(" ").mark(["<",">"],1),!1;for(v in c)v=" "+b(c[v]).replace(/^\[|\]:$/g,""),T.a[v]=1;return p=T.a,l.prompt(f.title[0],u,0,function(e,t,s){var v=""===s;s=_(s),t[0](),p[s]?(t.trim(b(r)?" ":"",/^\n+ {0,3}\*?\[/.test(a)?!1:" ").mark(["[","]["+s+"]"],0,!1),$=c.indexOf(" ["+s+"]:"),-1===$&&1!==p[s]&&(n=t.$(),r=n.before,g=n.start,m=n.end,t.set(r+i+b(n.after,1)+o+" ["+(s||b(i)||L[""])+"]: "+(v?"":p[s][0]+(p[s][1]?' "'+p[s][1]+'"':""))).select(g,m),v&&t.focus(1).insert(u))):(h=s,l.prompt(f.title[1],f.placeholder[1],0,function(e,t,n){d=k(n),i||t.insert(L[""]),t.i().trim(b(r)?" ":"",b(a)?/^\n+ {0,3}\*?\[/.test(a)?"\n\n ":" ":"").wrap("[","]("+h+(d?' "'+d+'"':"")+")")},0,0,"a[title]")),t[1]()},0,0,"a[href]").record(),!1}},img:{click:function(e,t){var d,$,g,m,v,y,w,n=t.$(),r=n.value,i=r,a=n.before,s=n.after,o=t.get(),c=/^ {0,3}\[[^\^]+?\]:/.test(o.split("\n").pop())?"\n":"\n\n",f=o.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],u=q.modals.img,p=/^\n* {0,3}\[.+?\]:/.test(s)?" ":"",h=b(s);for(w in f)w=" "+b(f[w]).replace(/^\[|\]:$/g,""),!T.img[w]&&(T.img[w]=1);return d=T.img,l.prompt(u.title[0],u.placeholder[0],1,function(e,t,s){s=_(s),$=s,i||(i=$.split(/[\/\\\\]/).pop()),i=k(i),t[0]().trim(b(a)?"\n\n":"",p),d[s]?(t.insert("!["+i+"]["+s+"]\n\n",0,1),p&&t.select(t.$().start),m=f.indexOf(" ["+s+"]:"),-1===m&&(n=t.$(),a=n.before,v=n.start,y=n.end,t.set(a+r+n.after+(h?c:"")+" ["+s+"]: "+d[s][0]+(d[s][1]?' "'+d[s][1]+'"':"")).select(v,y))):l.prompt(u.title[1],u.placeholder[1],0,function(e,t,n){g=k(n),t.insert("!["+i+"]("+$+(g?' "'+g+'"':"")+")\n\n",0,1),p&&t.select(t.$().start)},0,0,"img[title]"),t[1]()},0,0,"img[src]"),!1}},sub:0,sup:0,abbr:w?{click:function(t,n){var r=n.$(),i=b(r.value),a=q.modals.abbr,s=n.get(),o=v(i||L[""]),c=/^ {0,3}\*\[.+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",f=s.match(/^ {0,3}\*\[.+?\]:/gm)||[],u=T.abbr,p=0;for(p in f)f[p]=" "+b(f[p]);return p=f.indexOf(" *["+o+"]:"),i&&-1!==p?(p=s.indexOf(f[p])+3,n.select(p,p+o.length),e.scrollTop=n.$(1).caret[0].y,!1):(l.prompt(a.title,u[o]||a.placeholder,!u[i],function(e,t,n,l){if(n=k(n),t[0]().set(b(t.get(),1)+(r.before||i?c:"")+" *["+o+"]: ").focus(1).insert(n||l),o===L[""]){var a=t.$().start;t.select(a-3-o.length,a-3)}t[1]()},0,0,"abbr[title]").record(),!1)}}:0,p:{click:function(e,t){return t.$().length?(t.tidy("\n\n").replace(/([\t ]*\n[\t ]*){2,}/g,"\n\n"),!1):(t.tidy("\n\n").insert(L[""]).scroll(2),!1)}},br:{click:function(e,t){var n=y.advance_br;return!c(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",0).scroll(1),!1}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){I>5?I=0:I++;var n=t.$(),r=y["advance_h1,h2"],l="\\s?["+p(x.h1[0]+x.h2[0])+"]+\\s*",i=p(x.h1[1]),a=n.before.replace(g("["+i+"\\s]+$"),""),s=v(n.value).replace(g("^["+i+"\\s]+|["+i+"\\s]+$","g"),"").replace(g(l+"$"),"")||L[""],o=n.after.replace(g("^["+i+"\\s]+"),"").replace(g("^"+l),""),c=["",x.h1[r?0:1],x.h2[r?0:1],x.h3[0],x.h4[0],x.h5[0],x.h6[0]];return t[0]().set(a+s+o).select(a.length,(a+s).length).tidy("\n\n"),0===I||(3>I&&r?t.wrap("","\n"+s.replace(/./g,c[I])):t.wrap(c[I]+" ",y["close_h1,h2,h3,h4,h5,h6"]?" "+c[I]:"")),t[1](),!1}},"blockquote,q":{click:function(e,t){var n=t.$(),r=n.value,l=x.blockquote[0];return r===L[""]?(t.select(),!1):r?(t.tidy(g(l+" $").test(n.before)?!1:"\n\n")[g("^"+l).test(r)?"outdent":"indent"](l+" "),!1):(t[0]().tidy("\n\n").insert(l+" ",0).insert(L[""])[1](),!1)}},"pre,code":{click:function(e,t){var f,u,h,n=t.$(),r=n.before,l=n.value,a=y["advance_pre,code"],s=x.code,o=s[1]||s[0];return o=o+o+o,!c(a)&&a?a=o:c(a)&&-1!==a.indexOf("%")&&(a=d(a,[o])),f="( {4,}|\\t"+(c(a)?"|"+p(a):"")+")",g("(^|\\n)"+f+"?$").test(r)?a?(t.mark([a,a.split(/\s+/)[0]],0,"\n\n","\n"),!1):(a=O===i?i:"    ",l?l===L[""]&&g(f+"$").test(r)?(t.select(n.start-a.length,n.end),!1):(t.tidy("\n\n")[g("^"+f).test(l)?"outdent":"indent"](a),!1):(t[0]().tidy("\n\n"),u=t.$().start,h=a+L[""],t.insert(h).select(u+a.length,u+h.length)[1](),!1)):(t.mark(s[0]),!1)}},ul:{click:function(e,t){var b,n=t.$(),r=n.value,l=n.before,i=n.after,a=x.ul[0],s=x.ol[0],o=p(a),c=d(p(s),["\\d+"]),f=g("(^|\\n)([\\t ]*) "+o+" (.*)$"),u=g("^(.*) "+o+" ","gm"),h=g("(^|\\n)([\\t ]*) "+c+" (.*)$"),$=g("^(.*) "+c+" ","gm"),m=L[""];return r?(r===m?t.select():$.test(r)?t.replace($,"$1 "+a+" "):u.test(r)?t.replace(u,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+a+" $2"),!1):i&&l&&("\n"!==i[0]||"\n"!==l.slice(-1))?(b=h.test(l)?l.replace(h,"$1$2 "+a+" $3"):f.test(l)?l.replace(f,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+a+" $3"),t.set(b+i).select(b.length),!1):(t[0]().tidy("\n\n").insert(" "+a+" ",0).insert(m)[1](),!1)}},ol:{click:function(e,t){var k,n=t.$(),r=n.value,l=n.before,i=n.after,a=x.ul[0],s=x.ol[0],o=d(s,[1]),c=p(a),f=d(p(s),["\\d+"]),u=g("(^|\\n)([\\t ]*) "+c+" (.*)$"),h=g("^(.*) "+c+" ","gm"),$=g("(^|\\n)([\\t ]*) "+f+" (.*)$"),m=g("^(.*) "+f+" ","gm"),b=L[""],v=0;return r?(r===b?t.select():h.test(r)?t.replace(h,function(e,t,n){return++v,t+" "+d(s,[v])+" "}):m.test(r)?t.replace(m,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++v,t+" "+d(s,[v])+" "+n}),!1):i&&l&&("\n"!==i[0]||"\n"!==l.slice(-1))?(k=u.test(l)?l.replace(u,"$1$2 "+o+" $3"):$.test(l)?l.replace($,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+o+" $3"),t.set(k+i).select(k.length),!1):(t[0]().tidy("\n\n").insert(" "+o+" ",0).insert(b)[1](),!1)}},table:w?function(e,t){var c,f,p,n=T.tr,r=T.td,i=q.modals.table,a=q.placeholders.table,s=d(a[0],[1,1]),o=[];return t[0]().$().value===s?(t.select(),!1):(l.prompt(i.title[0],i.placeholder[0],0,function(e,t,h,g){f=u($(h)||g,r[0],r[1]),l.prompt(i.title[1],i.placeholder[1],0,function(e,t,r,l){p=u($(r)||l,n[0],n[1]);var i,h,g,m,b,v;for(i=0;p>i;++i){for(c="|",h=0;f>h;++h)c+=" "+d(a[1],[i+1,h+1])+" |";o.push(c)}for(o=o.join("\n"),c="|",g=0;f>g;++g)c+=" "+d(a[0],[g+1,g+1]).replace(/./g,"-")+" |";for(o=c+"\n"+o,c="|",m=0;f>m;++m)c+=" "+d(a[0],[1,m+1])+" |";o=c+"\n"+o,y.close_tr||(o=o.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(o),b=t.$(),v=b.start+b.value.indexOf(s),t.select(v,v+s.length)[1]()},0,0,"table>tr")},0,0,"table>td"),!1)}:0,hr:{click:function(e,t){return t.tidy("\n\n","").insert(x.hr[0]+"\n\n",0).scroll(2),!1}},note:w?{click:function(t,n){var p,r=n.$(),i=r.before,a=r.after,s=q.modals.note,o=n.get(),c=/^ {0,3}\[\^.+?\]:/.test(b(o).split("\n").pop())?"\n":"\n\n",f=o.match(/^ {0,3}\[\^.+?\]:/gm)||[],u=0;for(u in f)f[u]=" "+b(f[u]);return u=f.length+1,l.prompt(s.title,r.value||u,0,function(t,n,r,l){r=b(r||l)||u,p=f.indexOf(" [^"+r+"]:"),-1!==p?(u=o.indexOf(f[p])+3,n.select(u,u+r.length),e.scrollTop=n.$(1).caret[0].y):n.trim(b(i)?" ":"",!b(a)||/^[\t ]*\n+[\t ]*/.test(a)?"\n\n":" ").insert("[^"+r+"]").set(b(n.get(),1)+c+" [^"+r+"]: ").focus(1).insert(L[""])},0,0,"note[id]"),!1}}:0}),h(l.keys,{enter:function(e,t){var n=t.$(),r=L[""],l=x.blockquote[0],a=(x.ul[0],x.ol[0]),s=d(p(a),["\\d+"]),o="(("+p(l)+" )+|"+S+"| +("+s+") )",c=g("^"+o+".*$","gm").exec(n.before.split("\n").pop());if(c){if(c[0]===c[1])return t[0]().insert("").outdent(g(o))[1](),!1;if(g("\\s*"+s+"\\s*").test(c[1])){var f=$(b(c[1]));return t[0]().insert("\n"+c[1].replace(/\d+/,f+1),0).insert(r).scroll(1)[1](),!1}return t[0]().insert("\n"+c[1],0).insert(r).scroll(1)[1](),!1}},"shift+tab":function(e,t){var b,n=t.$(),r=n.before,i=n.value,a=n.after,s=L[""],o=x.ol[0],c=p(o),f=d(c,["\\d+"]),u=p(x.blockquote[0]),h=g("  "+S+"$"),$=g("   ( ?"+f+" )$"),m="("+u+" |"+S+"| +"+f+" )";if(i&&i!==s){if(i&&(b=i.match(g("(^|\\n)"+m,"g"))))return t.outdent(g(m)),!1}else{if(b=r.match(g(u+" $")))return t[0]().insert("").outdent(b[0]).insert(i)[1](),!1;if(b=r.match(h))return r=r.replace(h,"$1"),t.set(r+i+a).select(r.length,(r+i).length),!1;if(b=r.match($))return r=r.replace($,"$1"),t.set(r+i+a).select(r.length,(r+i).length),!1}return l.tools.outdent.click(e,t)},tab:function(e,t){var m,n=t.$(),r=n.before,i=n.value,a=n.after,s=L[""],o=x.ol[0],c=x.blockquote[0],f=p(o),u=p(c),h=g(S+"$"),$=g(" ?"+d(f,["\\d+"])+" $");if(i&&i!==s){if(g("^"+u+" ").test(i))return t.indent(c+" "),!1}else{if(m=r.match(g(u+" $")))return t.insert(m[0],0),!1;if(m=r.match(h))return r=r.replace(h,"  $1"),t.set(r+i+a).select(r.length,(r+i).length),!1;if(m=r.match($))return r=r.replace($,"    "+d(o,[1])+" "),t.set(r+i+a).select(r.length,(r+i).length),!1}return l.tools.indent.click(e,t)},"control+down":"note","control+up":"note"}),r.update({},0)};